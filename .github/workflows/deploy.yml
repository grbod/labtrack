name: Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_backend:
        description: 'Skip backend deployment'
        required: false
        default: 'false'
        type: boolean
      skip_frontend:
        description: 'Skip frontend deployment'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: deploy-vps
  cancel-in-progress: false

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================================================
  # Build Frontend
  # ============================================================================
  build-frontend:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_frontend != 'true' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        env:
          VITE_API_URL: '/api'
          VITE_GIT_SHA: ${{ github.sha }}
        run: npm run build

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist
          retention-days: 1

  # ============================================================================
  # Deploy to VPS
  # ============================================================================
  deploy:
    runs-on: ubuntu-latest
    needs: [build-frontend]
    if: always() && (needs.build-frontend.result == 'success' || needs.build-frontend.result == 'skipped')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download frontend artifact
        if: ${{ github.event.inputs.skip_frontend != 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy backend
        if: ${{ github.event.inputs.skip_backend != 'true' }}
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            set -e

            cd /opt/labtrack

            # Allow git to operate on this directory (ownership differs)
            git config --global --add safe.directory /opt/labtrack || true

            # Pull latest code
            git fetch origin main
            git reset --hard origin/main

            # Update backend dependencies
            cd backend
            source venv/bin/activate
            pip install -r requirements.txt --quiet

            # Run database migrations (auto-stamps on first Alembic deploy)
            python -c "from app.database import init_db; init_db()"

            # Update systemd service file if changed
            if ! diff -q /opt/labtrack/deploy/labtrack-api.service /etc/systemd/system/labtrack-api.service &>/dev/null; then
              sudo cp /opt/labtrack/deploy/labtrack-api.service /etc/systemd/system/labtrack-api.service
              sudo systemctl daemon-reload
              echo "Systemd service file updated"
            fi

            # Restart API service
            sudo systemctl restart labtrack-api

            echo "Backend deployed successfully"
          EOF

      - name: Deploy frontend
        if: ${{ github.event.inputs.skip_frontend != 'true' }}
        run: |
          # Copy built frontend to VPS
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key" \
            frontend/dist/ \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/var/www/labtrack/

          echo "Frontend deployed successfully"

      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            # Check API service is running
            if systemctl is-active --quiet labtrack-api; then
              echo "API service is running"
            else
              echo "ERROR: API service is not running"
              sudo journalctl -u labtrack-api --no-pager -n 20
              exit 1
            fi

            # Check nginx config
            sudo nginx -t

            # Health check with retry (service may need a moment to start)
            for i in 1 2 3; do
              if curl -sf http://127.0.0.1:8009/api/health > /dev/null 2>&1; then
                echo "Health check passed"
                break
              fi
              if [ "$i" -eq 3 ]; then
                echo "ERROR: Health check failed after 3 attempts"
                curl -s http://127.0.0.1:8009/api/health || true
                exit 1
              fi
              echo "Health check attempt $i failed, retrying in 3s..."
              sleep 3
            done

            echo "Deployment verified successfully"
          EOF

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/deploy_key
